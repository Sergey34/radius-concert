<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Радиус Концерт - События</title>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">


    <link href="/css/open-iconic-bootstrap.min.css" rel="stylesheet">
    <link href="/css/animate.css" rel="stylesheet">

    <link href="/css/owl.carousel.min.css" rel="stylesheet">
    <link href="/css/owl.theme.default.min.css" rel="stylesheet">
    <link href="/css/magnific-popup.css" rel="stylesheet">

    <link href="/css/aos.css" rel="stylesheet">

    <link href="/css/ionicons.min.css" rel="stylesheet">

    <link href="/css/bootstrap-datepicker.css" rel="stylesheet">
    <link href="/css/jquery.timepicker.css" rel="stylesheet">


    <link href="/css/flaticon.css" rel="stylesheet">
    <link href="/css/icomoon.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>
<body>

<div th:insert="fragments/navbar.html"/>
<!-- END nav -->

<div class="hero-wrap" style="background-image: url('/images/bg_3.jpg');">
    <div class="overlay"></div>
    <div class="container">
        <div class="row no-gutters slider-text d-flex align-itemd-center justify-content-center">
            <div class="col-md-9 ftco-animate text-center d-flex align-items-end justify-content-center">
                <div class="text">
                    <!--                    <p class="breadcrumbs mb-2"><span class="mr-2"><a href="/">Home</a></span>-->
                    <!--                        <span>Restaurant</span></p>-->
                    <h1 class="mb-4 bread">Концерты</h1>
                </div>
            </div>
        </div>
    </div>
</div>


<div th:insert="fragments/events.html"/>


<div th:insert="fragments/footer.html"/>


<!-- loader -->
<div th:insert="fragments/loader.html"/>


<script src="/js/jquery.min.js"></script>
<script src="/js/jquery-migrate-3.0.1.min.js"></script>
<script src="/js/popper.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/jquery.easing.1.3.js"></script>
<script src="/js/jquery.waypoints.min.js"></script>
<script src="/js/jquery.stellar.min.js"></script>
<script src="/js/owl.carousel.min.js"></script>
<script src="/js/jquery.magnific-popup.min.js"></script>
<script src="/js/aos.js"></script>
<script src="/js/jquery.animateNumber.min.js"></script>
<script src="/js/bootstrap-datepicker.js"></script>
<script src="/js/scrollax.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/fillEvents.js"></script>

<!-- Modal -->
<div aria-hidden="true" aria-labelledby="modalCitySelectorTitle" class="modal fade" id="modalCitySelector" role="dialog"
     tabindex="-1">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Выбери город</h5>
            </div>
            <div class="modal-body">
                <ul class="list-group" id="city_list">

                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    const [city, distance, metric, genre, start, end] = window.location.href.split('/').slice(4, 10);
    const eventTitle = window.location.href.split('?')[1].split("=")[1];

    function loadEventsByCity() {
        let citesTemplate = "{{#cites}}\n";
        let href = "<a href=\"/events/{{name}}/{{distance}}/{{metric}}\">\n";

        let url;
        if (distance === undefined) {
            url = `/api/events/${city}`;
            $('#current_city').text(decodeURI(city));
        } else {
            url = `/api/events/${city}/${distance}/${metric}`;
            $.get(`/api/geocode/${city}`)
                .then(it => {
                    $('#current_city').text(it.name);
                });
        }
        if (genre !== null && genre !== undefined) {
            url += `/${genre}`;
            href = "<a href=\"/events/{{name}}/{{distance}}/{{metric}}/{{genre}}\">\n";
            if (start !== null && start !== undefined && end !== null && end !== undefined) {
                url += `/${start}/${end}`;
                href = "<a href=\"/events/{{name}}/{{distance}}/{{metric}}/{{genre}}/{{start}}/{{end}}\">\n";
            }
        }

        citesTemplate += href + "    <li class=\"list-group-item\">{{name}}</span>\n" +
            "    </li></a>\n" +
            "{{/cites}}";
        $.get(url)
            .then(data => {
                console.log(data);
                if (data.length > 0) {
                    events_stored = data;
                    fillEvents(0, 50);
                }
            })
            .catch(err => {
                if (err.status !== 404) {
                    return
                }
                $.get(`/api/geocodes/${city}`)
                    .then(geocodes => {
                        let cites = Mustache.render(citesTemplate, {
                            cites: geocodes,
                            distance: distance,
                            metric: metric,
                            genre: genre,
                            start: start,
                            end: end
                        });
                        $('#city_list').html(cites);

                        $('#modalCitySelector').modal({
                            backdrop: 'static',
                            keyboard: false
                        });
                    });
            });
    }

    function loadEventsByEventTitle() {
        $.get(`/api/events/title/${decodeURI(eventTitle).replace('+', ' ')}`)
            .then(data => {
                console.log(data);
                if (data.length > 0) {
                    events_stored = data;
                    fillEvents(0, 50);
                }
            })
    }

    if (!eventTitle) {
        loadEventsByCity();
    } else {
        loadEventsByEventTitle();
    }

</script>
</body>
</html>